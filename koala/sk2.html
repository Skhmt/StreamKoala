
<!--
	http://closure-compiler.appspot.com/home
	https://toddmotto.com/mastering-the-module-pattern/
	http://codepen.io/ashleynolan/pen/wBppKz
	https://flatuicolors.com/
-->
<html lang="en">
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	<title>StreamKoala 2.0</title>


	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
		integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.6/slate/bootstrap.min.css" crossorigin="anonymous">
	<script src="https://www.youtube.com/iframe_api"></script>
	<script>
////////////////////////////////////////////////////////////////////////////////

var ws;
var username;
var channelname;
var emoticons = [];
var currentGame = '';
var currentStatus = '';
var subbadgeUrl = '';

$( function() {
	var clientid = 'idc20bfbuv46327tp8jgc6qhznewz9'; //streamkoala public client id
	var oauth = 'oauth:2pu8wfd54k0magaxl9gj3mdy9feqat';

	$('#chatForm').submit(function(e) {
		e.preventDefault();
		chat( $('#chatText').val() );
		$('#chatText').val('');
	} );

	$('.updateStatusButton').click( function() {
		changeStatusOpen();
	} );

	$('#saveStatusButton').click( function() {
		changeStatusSubmit( oauth.substring(6) );
	} );

	getEmoticons();
	getUsername(clientid, oauth);

} );

function getUsername( clientid, token ) {
	$.getJSON(
		'https://api.twitch.tv/kraken?callback=?',
		{
			"client_id" : clientid,
			"api_version" : 3,
			"oauth_token" : token.substring(6)
		},
		function(response){
			username = response.token.user_name;
			channelname = 'bobross';

			$('#username').html(username);
			$('#twitchVideo').attr('src', 'http://player.twitch.tv/?autoplay=true&muted=true&channel=' + channelname);

			runChat(token, username, channelname);

			getStreamInfo(clientid, true);
			getOnline(clientid);
			getSubBadgeUrl(clientid);
			updateUserlist(clientid);
		}
	);
}

function runChat( token, nick, channel) {
	$.getJSON(
		`https://api.twitch.tv/api/channels/${channel}/chat_properties?callback=?`,
		function( response ) {

			var server = response.web_socket_servers[ Math.floor( Math.random() * response.web_socket_servers.length ) ];
			server = 'ws://' + server;

			ws = new WebSocket( server );

			ws.onopen = function (event) {
				ws.send( 'CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership' );
				ws.send( `PASS ${token}` );
				ws.send( `NICK ${nick}` );
				ws.send( `JOIN #${channel}` );
			}

			// show raw data
			ws.onmessage = function(event) {
				var messages = event.data.split( '\r\n' );
				for ( var i = 0; i < messages.length; i++ ) {
					var msg = messages[i]
					if ( msg === 'PING :tmi.twitch.tv' ) {
						ws.send( 'PONG :tmi.twitch.tv' );
						console.log( 'PONG' );
					}
					else {
						parseMessage( msg );
					}
				}
			};

		} // function()
	);  // $.getJSON(
}

// @color=#1E90FF;display-name=Skhmt;emotes=;mod=0;room-id=71619374;subscriber=0;turbo=0;user-id=71619374;user-type= :skhmt!skhmt@skhmt.tmi.twitch.tv PRIVMSG #skhmt :test
// :brianhunter314!brianhunter314@brianhunter314.tmi.twitch.tv JOIN #skhmt
// @msg-id=host_on :tmi.twitch.tv NOTICE #skhmt :Now hosting M3rchant.
function parseMessage( text ) {
	var textarray = text.split(' ');

	if ( textarray[2] === 'PRIVMSG' ) {
		var command = textarray[0];
		textarray.splice( 0, 1 );
		msgPriv( command, textarray );
	}
	else if ( textarray[2] === 'NOTICE' ) {
		textarray.splice( 0, 4 );
		var output = textarray.join(' ').substring(1);
		log( `<b>* ${output}</b>` );
	} else if ( textarray[1] === 'JOIN' ) {
		var joinname = textarray[0].split('!')[0].substring(1);
		log( `<b>* ${joinname} has joined.</b>` );
	} else {
		console.log( text );
	}
}

function msgPriv( command, args ) {

	var commands = command.split( ';' );
	var color = '#d2691e';
	var mod = false;
	var subscriber = false;
	var turbo = false;
	var from = '';

	for ( var i = 0; i < commands.length; i++ ) {
		commands[i] = commands[i].split( '=' );
		var tempParamName = commands[i][0];
		var tempParamValue = commands[i][1];
		if (tempParamName == 'display-name') {
			if (tempParamValue === '') { // some people don't have a display-name, so getting it from somewhere else as a backup
				var tempArgs = args[0].split( '!' );
				from = tempArgs[0];
			} else {
				from = tempParamValue;
			}
		}
		else if ( tempParamName == '@color' && tempParamValue != '' ) {
			color = tempParamValue;
		}
		else if ( tempParamName == 'mod' && tempParamValue == '1' ) {
			mod = true;
		}
		else if ( tempParamName == 'subscriber' && tempParamValue == '1' ) {
			subscriber = true;
		}
		else if ( tempParamName == 'turbo' && tempParamValue == '1' ) {
			turbo = true;
		}

	}

	// writing output and setting timestamp
	var output = '';

	// output icons and such
	if ( username === from.toLowerCase() ) {
		output += '<img src="http://chat-badges.s3.amazonaws.com/broadcaster.png">';
	}
	if ( mod ) {
		output += '<img src="http://chat-badges.s3.amazonaws.com/mod.png">';
	}
	if ( subscriber ) {
		output += `<img src="${subBadgeUrl}">`;
	}
	if ( turbo ) {
		output += '<img src="http://chat-badges.s3.amazonaws.com/turbo.png">';
	}

	// output FROM info
	output += `<strong style='color: ${color};'>${from}</strong>`;


	// reconstructing the string after it was split by " "
	var text = args[3].substring(1); // first word, removed the colon

	args.splice(0,4);
	var lessargs = args.join(" "); // all other words

	 // ACTION:
		// Command: @color=#1E90FF;display-name=Skhmt;emotes=;subscriber=0;turbo=0;user-id=71619374;user-type=
		// Args 0: skhmt!skhmt@skhmt.tmi.twitch.tv PRIVMSG #skhmt :ACTION does things

	if ( text === '\001ACTION' ) {
		text = lessargs; // text is now all words after "ACTION"
		output += `<span style='color: ${color};'>
			${text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}
			</span>`;

		// moderation( from, mod, text );
		return log( output );
	}
	else { // not an action
		text += ' ' + lessargs; // text is merged with lessargs to make up the entire text string
		output += `<b>:</b> &nbsp;&nbsp; ${text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}`;

		// if it's a command, send to parseCommand
		// if ( text.substring(0,1) === cmdSettings.symbol ) {
		// 	parseCommand( text, from, mod, subscriber );
		// }

		// moderation( from, mod, text );

		return log( output );
	}
}

function chat( text ) {
	// check if it was a command...
	// if ( text.substring(0, 1) === cmdSettings.symbol ) {
	// 	parseCommand( text, settings.username, true, true);
	// }
	// else {
		// send the data to the irc server
		ws.send( `PRIVMSG #${channelname} :${text}` );
	// }

	log( `<strong>&gt;</strong> &nbsp;&nbsp; ${text.replace(/</g,"&lt;").replace(/>/g,"&gt;")}` );
}

function log( text ) {
	var out = document.getElementById('con');

	// if it's scrolled to the bottom before a chat message shows up, set isScrolledToBottom to true
	// https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollHeight
	var isScrolledToBottom = ( ( out.scrollHeight - out.scrollTop - out.clientHeight) <= 20 );

	// add message
	$('#con').append( `${writeEmoticons(text)}<br>` );

	// if it was scrolled to the bottom before the message was appended, scroll to the bottom
	if( isScrolledToBottom ) {
		out.scrollTop = Number.MAX_SAFE_INTEGER;
	}
}

function getEmoticons() {
	// Global
	$.getJSON(
		'https://twitchemotes.com/api_cache/v2/global.json',
		function( response ) {
			if ( 'emotes' in response ) {
				for (var i in response.emotes) {
					emoticons[i] = `https://static-cdn.jtvnw.net/emoticons/v1/${response.emotes[i].image_id}/1.0`;
				}
			}
		}
	);

	// Subscribers
	$.getJSON(
		'https://twitchemotes.com/api_cache/v2/subscriber.json',
		function( response ) {
			if ( 'channels' in response ) {
				var start = $.now();
				for (var i in response.channels) {
					for (var j in response.channels[i].emotes) {
						var code = response.channels[i].emotes[j].code;
						var image_id = response.channels[i].emotes[j].image_id;
						emoticons[code] = `https://static-cdn.jtvnw.net/emoticons/v1/${image_id}/1.0`;
					}
				}
				console.log( `Time to process sub emotes: ${$.now() - start}ms` );
			}
		}
	);
}

function writeEmoticons( message ) {
	var output = '';
	var text = message.split(' ');

	var arrayWords = ['every',
		'join',
		'concat',
		'filter',
		'map',
		'pop',
		'push',
		'reduce',
		'reverse',
		'shift',
		'some',
		'slice',
		'sort',
		'unshift',
		'length',
		'prototype',
		'constructor',
		'find'
	];

	// for each word, check if it's an emoticon and if it is, output the url instead of the text
	for( var i = 0; i < text.length; i++ ) {
		var word = text[i];
		// Check arrayWords...
		var found = false;
		for( var x = 0; x < arrayWords.length; x++ ) {
			if ( arrayWords[x] == word ) {
				found = true;
				break;
			}
		}

		if (!found && emoticons[word] ) {
			output += `<abbr title="${word}" style="border: 0;"><img src="${emoticons[word]}"></abbr> `;
		}
		else {
			output += `${word} `;
		}
	}

	return output;
}

function getStreamInfo( clientid, repeat ) {
	$.getJSON(
		`https://api.twitch.tv/kraken/channels/${channelname}?callback=?`,
		{
			"client_id" : clientid,
			"api_version" : 3
		},
		function(response) {
			currentGame = response.game;
			currentStatus = response.status;
			$('#game').html( currentGame );
			$('#status').html( currentStatus );
			if ( repeat ) {
				setTimeout(function() {
					getStreamInfo( clientid, true );
				}, 30*1000);
			}
		}
	);
}

function getOnline( clientid ) {
	$.getJSON(
		`https://api.twitch.tv/kraken/streams/${channelname}?callback=?`,
		{
			"client_id" : clientid,
			"api_version" : 3
		},
		function(response) {
			if ( !response.stream ) {
				document.getElementById('username').className = 'text-danger';
			}
			else {
				document.getElementById('username').className = 'text-success';
			}
			setTimeout(function() {
				getOnline(clientid);
			}, 45*1000);
		}
	);
}

function changeStatusSubmit( token ) {
	var newGame = $('#updateGame').val();
	var newStatus = $('#updateStatus').val();
	$('#changeStatusModal').modal('hide');
	$.get(
		`https://api.twitch.tv/kraken/channels/${channelname}`,
		{
			"channel[game]": newGame,
			"channel[status]": newStatus,
			"_method": "put",
			"oauth_token": token
		}, function() {
			getStreamInfo( token, false );
		}
	);
}

function changeStatusOpen() {
	$('#changeStatusModal').modal('show');
	$('#updateGame').val( currentGame );
	$('#updateStatus').val( currentStatus );
}

function getSubBadgeUrl( clientid ) {
	$.getJSON(
		`https://api.twitch.tv/kraken/chat/${channelname}/badges`,
		{
			"client_id" : clientid,
			"api_version" : 3
		},
		function( response ) {
			if ( response.subscriber != null ) {
				subBadgeUrl = response.subscriber.image;
			}
		}
	);
}

function updateUserlist(clientid) {
	console.log('Updating user list on ' + channelname);

	$.getJSON(
		'https://tmi.twitch.tv/group/user/' + channelname + '/chatters?callback=?',
		{
			"client_id": clientid,
			"api_version": 3
		},
		function(res) {
			var response = res.data;

			if (!response.chatters) {
			 	console.log('No response from user list.'); // didn't load a user yet
				return console.log(JSON.stringify(response));
			}

			var output = '';

			if (response.chatters.staff.length) {
				output += `<p> <b style="color: #6d35ac;">STAFF (${response.chatters.staff.length})</b> <br> `;
				for (var i = 0; i < response.chatters.staff.length; i++) {
					var tempuser = response.chatters.staff[i];
					output += `${tempuser} <br> `;
				}
				output += '</p> ';
			}

			if (response.chatters.moderators.length) {
				output += `<p> <b style="color: #34ae0a;">MODS (${response.chatters.moderators.length})</b> <br> `;
				for (var i = 0; i < response.chatters.moderators.length; i++) {
					var tempuser = response.chatters.moderators[i];
					output += `${tempuser} <br> `;
				}
				output += '</p> ';
			}

			if (response.chatters.admins.length) {
				output += `<p> <b style="color: #faaf19;">ADMINS (${response.chatters.admins.length})</b> <br> `;
				for (var i = 0; i < response.chatters.admins.length; i++) {
					var tempuser = response.chatters.admins[i];
					output += `${tempuser} <br> `;
				}
				output += '</p> ';
			}

			if (response.chatters.global_mods.length) {
				output += `<p> <b style="color: #1a7026;">GLOBAL MODS (${response.chatters.global_mods.length})</b> <br> `;
				for (var i = 0; i < response.chatters.global_mods.length; i++) {
					var tempuser = response.chatters.global_mods[i];
					output += `${tempuser} <br> `;
				}
				output += '</p> ';
			}

			if (response.chatters.viewers.length) {
				output += `<p> <b style="color: #2e7db2;">VIEWERS (${response.chatters.viewers.length})</b> <br> `;
				for (var i = 0; i < response.chatters.viewers.length; i++) {
					var tempuser = response.chatters.viewers[i];
					output += `${tempuser} <br> `;
				}
				output += '</p> ';
			}

			$('#userlist').html(output);

			updateViewerCount(response.chatter_count, clientid);
		}
	);

	setTimeout( function() {
		updateUserlist(clientid);
	}, 10*1000 );
}

function updateViewerCount( viewerCount, clientid ) {
	$.getJSON(
		`https://api.twitch.tv/kraken/channels/${channelname}/follows?callback=?`,
		{
			"client_id" : clientid,
			"api_version" : 3
		},
		function(response){
			var followerCount = response._total;
			$('#viewercount').html( `
				<span class="glyphicon glyphicon-user text-info"></span>
				&nbsp;&nbsp;&nbsp;${viewerCount.toLocaleString()}
				<br>
				<span class="glyphicon glyphicon-heart text-danger"></span>
				&nbsp;&nbsp;&nbsp;${followerCount.toLocaleString()}` );
		}
	);
}

////////////////////////////////////////////////////////////////////////////////
	</script>
</head>
<body>


<nav class="navbar navbar-default">
	<div class="container-fluid">
		<div class="navbar-header">
			<div class="navbar-brand">
				StreamKoala
			</div>
		</div>
		<div class="hidden-xs hidden-sm">
			<p class="navbar-text">
				<strong id="username"></strong>
			</p>

			<p class="navbar-text">
				<strong class="text-primary">Game: &nbsp;</strong>
				<em id="game"><!-- game dynamically generated --></em>
			</p>

			<p class="navbar-text">
				<strong class="text-primary">Status: &nbsp;</strong>
				<em id="status"><!-- status dynamically generated --></em>
			</p>
		</div>
		<div class="hidden-xs">
			<form class="nav navbar-form navbar-right" onsubmit="return false;">
				<button type="button" class="btn btn-default btn-md updateStatusButton">
					<span class="glyphicon glyphicon-cloud-upload"></span>
				</button>
			</form>
		</div>
	</div>
</nav>

<div class="container-fluid">
	<div class="row">

		<div class="col-xs-5 col-sm-5 col-md-4 col-lg-5" style="padding-left: 10; padding-right: 5;">
			<div class="panel panel-default" style="height: calc(100vh - 95px);">
				<div class="panel-heading">
			    	<h3 class="panel-title text-center">Chat</h3>
				</div>
				<div class="panel-body" id="con" style="overflow: auto; word-wrap: break-word; max-height: calc(100vh - 188px); min-height: calc(100vh - 186px);">
				</div>
				<div class="panel-footer">
					<form class="form-group" id="chatForm" style="margin-top: 0; margin-bottom: 0;">
						<div class="form-group" style="margin-top: 0; margin-bottom: 0;">
							<div class="input-group input-group-sm">
								<span class="input-group-addon">
									<span class="glyphicon glyphicon-console"></span>
								</span>
								<input type="text" class="form-control input-sm" id="chatText" value="" autocomplete="off" placeholder="chat...">
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div class="col-xs-3 col-sm-3 col-md-2 col-lg-2" style="padding-left: 5; padding-right: 5;">
			<div class="panel panel-default" style="height: calc(100vh - 95px);">
				<div class="panel-heading">
			    	<h3 class="panel-title text-center">Viewers</h3>
				</div>
				<div class="panel-body" style="height: 60px;" id="viewercount">
					<!-- viewercount dynamically generated -->
				</div>
				<div class="panel-body" style="height: calc(100vh - 196px); overflow: auto; word-wrap: break-word;" id="userlist">
					<!-- userlist dynamically generated -->
				</div>
			</div>
		</div>

		<div class="col-xs-4 col-sm-4 col-md-3 col-lg-2" style="padding-left: 5; padding-right: 10;">
			<div class="panel panel-default" style="height: calc(100vh - 95px);">
				<div class="panel-heading">
			    	<h3 class="panel-title text-center">TwitchAlerts</h3>
				</div>
				<div class="panel-body" style="max-height: calc(100vh - 135px);">

					<iframe src="http://www.twitchalerts.com/dashboard/recent-events"
						style="width: calc(100% + 30px); height: calc(100% + 28px); padding: 0; margin: -15px; border: 0;">&nbsp;</iframe>

				</div>
			</div>
		</div>

		<div class="hidden-xs hidden-sm col-md-3 col-lg-3" style="padding-left: 0; padding-right: 10;">
			<div class="panel panel-default" style="height: calc(100vh - 95px);">
				<div class="panel-heading">
			    	<h3 class="panel-title text-center">Stream</h3>
				</div>
				<ul class="list-group" style="max-height: calc(100vh - 135px);">
					<li class="list-group-item">
						<iframe id="twitchVideo" src="" style="width: calc(100% + 30px); height: 50%; border: 0; margin: -10px -15px -10px -15px;">&nbsp;</iframe>
					</li>
					<li class="list-group-item">
					</li>
				</ul>
			</div>
		</div>

	</div> <!-- row -->
</div> <!-- container -->

<!-- Change Game / Status Modal -->
<div id="changeStatusModal" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title">Update game and status</h4>
			</div>
			<div class="modal-body">
				<form onsubmit="return false;">
					<label for="updateGame">Game:</label>
					<input type="text" id="updateGame" class="form-control input-sm" autocomplete="on">
					<br>
					<label for="updateStatus">Stream Status:</label>
					<input type="text" id="updateStatus" class="form-control input-sm" autocomplete="off">
				</form>
			</div>
			<div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
		        <button type="button" class="btn btn-primary" id="saveStatusButton">Save</button>
		    </div>
		</div>  <!-- modal-content -->
	</div>  <!-- modal-dialog -->
</div>  <!-- modal -->


</body>
</html>
